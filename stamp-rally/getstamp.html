<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>スタンプ取得中...</title>
  <script>
    async function getStamp() {
      const params = new URLSearchParams(location.search);
      const spot = params.get("spot"); // A または B


      if (!spot) {
        document.body.textContent = "エラー：無効なURLです。";
        return;
      }

      // ローカル保存を読み込む
      const stamps = JSON.parse(localStorage.getItem("stamps") || "{}");

      // すでに取得済みなら
      if (stamps[spot]) {
        document.body.textContent = `スタンプ「${spot}」はすでに取得済みです。`;
        return;
      }

      // 新しく取得
      stamps[spot] = new Date().toISOString();
      localStorage.setItem("stamps", JSON.stringify(stamps));

      document.body.textContent = `🎉 スタンプ「${spot}」をゲットしました！`;

      // GASに記録
      await fetch("https://script.google.com/macros/s/AKfycbzk_1ioWFXeajvLX80b_wlBcpHq3K4JyA8pP6Ey568KDKquz1UEmiZvSJjxlU7X00b6UQ/exec", {
        method: "POST",
        body: JSON.stringify({
          spot,
          timestamp: new Date().toLocaleString(),
          clientId: localStorage.getItem("clientId") || (() => {
            const id = crypto.randomUUID();
            localStorage.setItem("clientId", id);
            return id;
          })()
        })
      });

      // 数秒後に台紙へ戻る
      setTimeout(() => location.href = "index.html", 2000);
    }

    window.onload = getStamp;
  </script>
</head>
<body>
  <p>スタンプを取得中です...</p>
</body>
</html>
