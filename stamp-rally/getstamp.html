<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>now Lowding...</title>
  <script>
    const TEST_MODE = true; // ← true の間は何回でもスタンプ取得

    async function getStamp() {
      const params = new URLSearchParams(location.search);
      const spot = params.get("spot"); // スタンプスポットIDを取得

      if (!spot) {
        document.body.textContent = "エラー：無効なURLです。";
        return;
      }

      // ローカル保存を読み込む
      const stamps = JSON.parse(localStorage.getItem("stamps") || "{}");

      // すでに取得済みならスキップ（ただしテストモード時は無視）
      if (!TEST_MODE && stamps[spot]) {
        document.body.textContent = `スタンプ「${spot}」はすでに取得済みです。`;
        return;
      }

      // スタンプ取得を記録（上書きOK）
      stamps[spot] = new Date().toISOString();
      localStorage.setItem("stamps", JSON.stringify(stamps));

      document.body.textContent = `now Lowding...`;

      // GASに記録
      await fetch("https://script.google.com/macros/s/AKfycbzoXW9CmzR69jF-KWx03sm3bG9W3fj43Sz4qHE5DjYm5VlkwT9-uzfYYcoycwOvFOCXJA/exec", {
        method: "POST",
        body: JSON.stringify({
          clientId: localStorage.getItem("clientId") || (() => {
            const id = crypto.randomUUID();
            localStorage.setItem("clientId", id);
            return id;
          })(),
          spot
        })
      });

      // 数秒後に台紙へ戻る
      setTimeout(() => location.href = "index.html", 500);
    }

    window.onload = getStamp;
  </script>
</head>
<body>
  <p>スタンプを取得中です...</p>
</body>
</html>
