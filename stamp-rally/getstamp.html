<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  
        <meta content="width=device-width, initial-scale=1.0,
        minimum-scale=1.0, maximum-scale=1.0">
  <title>ã‚¹ã‚¿ãƒ³ãƒ—å–å¾—ä¸­...</title>
  <script>
    const TEST_MODE = true; // â† true ã®é–“ã¯ä½•å›ã§ã‚‚ã‚¹ã‚¿ãƒ³ãƒ—å–å¾—OKï¼

    async function getStamp() {
      const params = new URLSearchParams(location.search);
      const spot = params.get("spot"); // A ã¾ãŸã¯ B

      if (!spot) {
        document.body.textContent = "ã‚¨ãƒ©ãƒ¼ï¼šç„¡åŠ¹ãªURLã§ã™ã€‚";
        return;
      }

      // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚’èª­ã¿è¾¼ã‚€
      const stamps = JSON.parse(localStorage.getItem("stamps") || "{}");

      // ã™ã§ã«å–å¾—æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãŸã ã—ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ç„¡è¦–ï¼‰
      if (!TEST_MODE && stamps[spot]) {
        document.body.textContent = `ã‚¹ã‚¿ãƒ³ãƒ—ã€Œ${spot}ã€ã¯ã™ã§ã«å–å¾—æ¸ˆã¿ã§ã™ã€‚`;
        return;
      }

      // ã‚¹ã‚¿ãƒ³ãƒ—å–å¾—ã‚’è¨˜éŒ²ï¼ˆä¸Šæ›¸ãOKï¼‰
      stamps[spot] = new Date().toISOString();
      localStorage.setItem("stamps", JSON.stringify(stamps));

      document.body.textContent = `ğŸ‰ ã‚¹ã‚¿ãƒ³ãƒ—ã€Œ${spot}ã€ã‚’ã‚²ãƒƒãƒˆã—ã¾ã—ãŸï¼`;

      // GASã«è¨˜éŒ²
      await fetch("https://script.google.com/macros/s/AKfycbzrcTtzMZvswUeK5X1bCnZIlXZ7ta0DKylpTqNzTKsvKfL-kFObnoIxIbrlVtlk0qpJCw/exec", {
        method: "POST",
        body: JSON.stringify({
          spot,
          timestamp: new Date().toLocaleString(),
          clientId: localStorage.getItem("clientId") || (() => {
            const id = crypto.randomUUID();
            localStorage.setItem("clientId", id);
            return id;
          })()
        })
      });

      // æ•°ç§’å¾Œã«å°ç´™ã¸æˆ»ã‚‹
      setTimeout(() => location.href = "index.html", 2000);
    }

    window.onload = getStamp;
  </script>
</head>
<body>
  <p>ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å–å¾—ä¸­ã§ã™...</p>
</body>
</html>
