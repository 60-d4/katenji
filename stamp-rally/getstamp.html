<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¹ã‚¿ãƒ³ãƒ—å–å¾—ä¸­...</title>
  <script>
    async function getStamp() {
      const params = new URLSearchParams(location.search);
      const spot = params.get("spot"); // A ã¾ãŸã¯ B


      if (!spot) {
        document.body.textContent = "ã‚¨ãƒ©ãƒ¼ï¼šç„¡åŠ¹ãªURLã§ã™ã€‚";
        return;
      }

      // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚’èª­ã¿è¾¼ã‚€
      const stamps = JSON.parse(localStorage.getItem("stamps") || "{}");

      // ã™ã§ã«å–å¾—æ¸ˆã¿ãªã‚‰
      if (stamps[spot]) {
        document.body.textContent = `ã‚¹ã‚¿ãƒ³ãƒ—ã€Œ${spot}ã€ã¯ã™ã§ã«å–å¾—æ¸ˆã¿ã§ã™ã€‚`;
        return;
      }

      // æ–°ã—ãå–å¾—
      stamps[spot] = new Date().toISOString();
      localStorage.setItem("stamps", JSON.stringify(stamps));

      document.body.textContent = `ğŸ‰ ã‚¹ã‚¿ãƒ³ãƒ—ã€Œ${spot}ã€ã‚’ã‚²ãƒƒãƒˆã—ã¾ã—ãŸï¼`;

      // GASã«è¨˜éŒ²
      await fetch("https://script.google.com/macros/s/AKfycbzk_1ioWFXeajvLX80b_wlBcpHq3K4JyA8pP6Ey568KDKquz1UEmiZvSJjxlU7X00b6UQ/exec", {
        method: "POST",
        body: JSON.stringify({
          spot,
          timestamp: new Date().toLocaleString(),
          clientId: localStorage.getItem("clientId") || (() => {
            const id = crypto.randomUUID();
            localStorage.setItem("clientId", id);
            return id;
          })()
        })
      });

      // æ•°ç§’å¾Œã«å°ç´™ã¸æˆ»ã‚‹
      setTimeout(() => location.href = "index.html", 2000);
    }

    window.onload = getStamp;
  </script>
</head>
<body>
  <p>ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å–å¾—ä¸­ã§ã™...</p>
</body>
</html>
